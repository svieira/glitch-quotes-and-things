const FORTUNES = `
A programmer is a person who passes as an exacting expert on the basis of being able to turn out, after innumerable punching, an infinite series of incomprehensive answers calculated with micrometric precisions from vague assumptions based on debatable figures taken from inconclusive documents and carried out on instruments of problematical accuracy by persons of dubious reliability and questionable mentality for the avowed purpose of annoying and confounding a hopelessly defenseless department that was unfortunate enough to ask for the information in the first place.
%
Laughter is the closest distance between two people.
%
There was a boy called Eustace Clarence Scrubb, and he almost deserved it.
%
"Where shall I begin, please your Majesty?" he asked. "Begin at the beginning," the King said, gravely, "and go on till you come to the end: then stop."
%
"Yacc" owes much to a most stimulating collection of users, who have goaded me beyond my inclination, and frequently beyond my ability in their endless search for "one more feature". Their irritating unwillingness to learn how to do things my way has usually led to my doing things their way; most of the time, they have been right.
~ S. C. Johnson, "Yacc guide acknowledgements"
%
The great Gaels of Ireland are the men that God made mad,
For all their wars are merry, and all their songs are sad.
%
This was a test of the emergency broadcasting system. Had this been an actual emergency, we would have fled in terror and you would not have been informed.
%
There can be no public or private virtue unless the foundation of all action is the love and practice of truth
%
43rd Law of Computing: Anything that can go wr
\`fortune: Segmentation fault ― core dumped\`
%
A moose once bit my sister.
%
"Analysis" is "design" spelled backwards.
%
A bad workman quarrels with his tools.
%
A fly by night leaves no shadow beyond a doubt.
%
A good plan today is better than a perfect plan tomorrow.
%
A goodly apple rotten at the heart:
Oh, what a goodly outside falsehood hath!
%
A plucked goose doesn't lay golden eggs.
%
A rolling stone gathers momentum.
%
A stitch in time keeps your tu-tu from becoming a four-four.
%
A watched terminal never prints.
%
All syllogisms have three parts; therefore this is not a syllogism.
%
A system programmer is someone who debugs his programs with an oscilloscope.
%
\`\`\`
login:
	case '\\7': *((char *)(384*1024L+062)) = 2; /* beep */
	Welcome to VAX/VMS Version 1.60
    ON ENDFILE(SYSIN) GO TO ADATHIBA; /* FILE-VEGE VIZSGALATA */
   Tape dump of all filesystems taken this afternoon.
\`\`\`
%
Another good night not to sleep in a eucalyptus tree.
%
Any excuse will serve a tyrant.
%
Any sufficiently advanced bureaucracy is indistinguishable from molasses.
%
If you drop a piece of buttered toast it lands buttered side down
%
Beware of bugs in the above code; I have only proved it correct, not tried it.
%
Beware of Programmers who carry screwdrivers.
%
Bombeck's Rule of Medicine: Never go to a doctor whose office plants have died.
%
Bradley's Bromide: If computers get too powerful, we can organize them into a committee. That will do them in.
%
An ounce of prevention is worth a pound of cure.
%
But in our enthusiasm, we could not resist a radical overhaul of the system, in which all of its major weaknesses have been exposed, analyzed, and replaced with new weaknesses.
%
A witty saying proves nothing.
%
According to the latest official figures, ${Math.floor(Math.random() * 88)}% of all statistics are totally worthless.
%
All programmers are playwrights and all computers are lousy actors.
%
All things are possible except skiing through a revolving door.
%
All wise men share one trait in common: the ability to listen.
%
Caution: Do not look at laser with remaining eye.
%
Could not open 2147478952 framebuffers.
%
Do not meddle in the affairs of wizards: they are subtle and quick to anger.
%
Don't feed the bats tonight.
%
Don't go surfing in South Dakota for a while.
%
Dreams are free, but there's a small charge for alterations.
%
Drive defensively, buy a tank.
%
Consistency is always easier to defend than correctness.
%
Allen's Axiom: When all else fails, read the instructions.
%
A person with one watch knows what time it is; a person with two watches is never sure.
%
A real patriot is the fellow who gets a parking ticket and rejoices that the system works.
%
A sine curve goes off into infinity or at least to the end of the blackboard.
%
A student who changes the course of history is probably taking an exam.
%
A language that doesn't have everything is actually easier to program in than some that do.
%
An adventure is only an inconvenience rightly considered. An inconvenience is only an adventure wrongly considered.
%
Drawing on my fine command of language, I said nothing.
%
Almost all good computer programs contain at least one random-number generator.
%
An ounce of application is worth a ton of abstraction.
%
Any clod can have the facts, but having opinions is an *art*.
%
Becoming an overnight success usually takes years.
%
I don't have any solution but I certainly admire the problem.
%
It's bad luck to be superstitious.
%
Mate, this parrot wouldn't VOOM if you put [four thousand volts through it](https://www.youtube.com/watch?v=4vuW6tQ0218)!
%
Might as well be frank, monsieur. It would take a miracle to get you out of Casablanca and the Germans have outlawed miracles.
%
Nondeterminism means never having to say you are wrong.
%
Of COURSE it's the murder weapon. Who would frame someone with a fake?
%
Stealing a rhinoceros should not be attempted lightly.
%
Captain Penny's Law: You can fool all of the people some of the time, and some of the people all of the time, but you can't fool Mom.
%
Zombie: 100% post-consumer human
%
Diplomacy is the art of extricating oneself from a situation that tact would have prevented in the first place.
%
Do not take life too seriously; you will never get out of it alive.
%
Don't comment bad code: rewrite it.
%
Endless Loop: n., see Loop, Endless.
Loop, Endless: n., see Endless Loop.
%
Entropy isn't what it used to be.
%
Eschew obfuscatory digressiveness.
%
Every program has at least one bug and can be shortened by at least one instruction ― from which, by induction, one can deduce that every program can be reduced to one instruction which doesn't work.
%
Excuse me while I change into something more formidable.
%
Fairy tales do not tell children the dragons exist. Children already know that dragons exist. Fairy tales tell children the dragons can be killed.
%
Fallacies do not cease to be fallacies because they become fashions.
%
A dead thing can go with the stream, but only a living thing can go against it.
%
The act of defending any of the cardinal virtues has today all the exhilaration of a vice.
%
To have a right to do a thing is not at all the same as to be right in doing it.
%
The comedy of man survives the tragedy of man.
%
The free man owns himself. He can damage himself with either eating or drinking; he can ruin himself with gambling. If he does he is certainly a damn fool, and he might possibly be a damned soul; but if he may not, he is not a free man any more than a dog.
%
When we step into the family, by the act of being born, we do step into a world which is incalculable, into a world which has its own strange laws, into a world which could do without us, into a world we have not made. In other words, when we step into the family we step into a fairy-tale.
%
A thing may be too sad to be believed or too wicked to be believed or too good to be believed; but it cannot be too absurd to be believed in this planet of frogs and elephants, of crocodiles and cuttle-fish.
%
Tradition means giving votes to the most obscure of all classes, our ancestors. It is the democracy of the dead. Tradition refuses to submit to that arrogant oligarchy who merely happen to be walking around.
%
When you break the big laws, you do not get freedom; you do not even get anarchy. You get the small laws.
%
> The Declaration of Independence dogmatically bases all rights on the fact that God created all men equal; and it is right; for if they were not created equal, they were certainly evolved unequal. There is no basis for democracy except in a dogma about the divine origin of man.
~ G. K. Chesterton
%
Over-civilization and barbarism are within an inch of each other. And a mark of both is the power of medicine-men.
%
The Bible tells us to love our neighbors, and also to love our enemies; probably because they are generally the same people.
%
The riddles of God are more satisfying than the solutions of man.
%
The truth is, of course, that the curtness of the Ten Commandments is an evidence, not of the gloom and narrowness of a religion, but, on the contrary, of its liberality and humanity. It is shorter to state the things forbidden than the things permitted: precisely because most things are permitted, and only a few things are forbidden.
%
Do not be too timid to endure responsibilities.
%
Art, like morality, consists of drawing the line somewhere.
%
A man preaching what he thinks is a platitude is far more intolerant than a man preaching what he admits is a paradox.
%
Courage is almost a contradiction in terms. It means a strong desire to live taking the form of a readiness to die.
%
There should be a burnished tablet let into the ground on the spot where some courageous man first ate Stilton cheese, and survived.
%
From quiet homes and first beginning,
Out to the undiscovered ends,
There's nothing worth the wear of winning,
But laughter and the love of friends.
%
Love is not affectionate feeling, but a steady wish for the loved person's ultimate good as far as it can be obtained.
%
Faith, in the sense in which I am here using the word, is the art of holding on to things your reason has once accepted, in spite of your changing moods.
%
The society which scorns excellence in plumbing as a humble activity and tolerates shoddiness in philosophy because it is an exaulted activity will have neither good plumbing nor good philosophy ... neither its pipes nor its theories will hold water.
%
Wisdom is acknowledging that other people may have made mistakes before you.
%
Shannon's six secrets: Simplification. Analogy. Reframing. Abstraction. Division. Inversion.
%
Use the least powerful language possible for a given problem. Prefer declarative languages over procedural.
%
All problems in computer science can be solved by another level of indirection
... except of course for the problem of too many indirections.
%
The height of cleverness is to be able to conceal it.
%
Design the data, not the code.
%
Give every man thy ear, but few thy voice
Take each man's censure, but reserve thy judgment.
%
"I think that I shall never see;
A graph more lovely than a tree.
A tree whose crucial property;
Is loop-free connectivity.
%
The first step in fixing a broken program is getting it to fail repeatably.
%
An articulated guess beats an unspoken assumption.
%
What's a dinosaur's favourite file format?
.rar
%
1998: Don't get into strangers' cars. Don't meet people from the internet. 
2016: Literally summon strangers from internet to get into their car.
%
Talent is hitting a target that nobody else can hit, genius is hitting a target that nobody else can see.
%
Man's most prudent counselor is time.
%
Those who do not forget the past are masters of the future.
%
Upon arriving in the capital-F Future, we discover it, invariably, to be the lowercase now.
%
No battle was ever won according to plan, but no battle was ever won without one.
`.split(/\n%\n/g).map(t => t.trim()).filter(s => !!s).map(s => s.indexOf(">") === 0 ? s : '>' + s.split('\n').join('\n>'));

const ICONS = `
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fimage.png?1501040026835
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fcookie.png?1501040330593
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fa-mirror.png?1501040717131
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fa-d6.png?1501040991773
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fa-d20.png?1501040996046
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fan-eight-ball.png?1501041066733
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fa-scroll.png?1501041303790
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fa-rabbit-foot.png?1501041428601
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fladybug.png?1502745717140
https://cdn.glitch.com/8568201b-555b-4c6e-8e58-9e525d75d1d7%2Fdolphin.png?1502745890182
`.trim().split('\n')

function toRegex(searchString) {
  searchString = searchString.replace(/([\?\.\*])/g, '\\$1').split('').join('.*?')
  const protoRegex = searchString.replace(/([+()\[\]{}\\])/g, '\\$1');
  try {    
    return RegExp(`.*?${protoRegex}.*?`, 'i');
  } catch (e) {
    return {
      test() {
        return true;
      }
    };
  }
}

function fortuneText(text) {
  if (!text.trim()) return choice(FORTUNES);
  const test = toRegex(text && text.trim() || '');
  return choice(FORTUNES.filter(f => test.test(f))) || choice(FORTUNES);
}

function choice(list) {
  return list[Math.floor(Math.random() * list.length)];
}

module.exports = function fortuneHandler(request, response) {
  
  const text = fortuneText(request.body.text);
  const icon_url = choice(ICONS);
  return response.json({
    username: 'Fortune Teller',
    response_type: 'in_channel',
    text,
    icon_url
  });
}